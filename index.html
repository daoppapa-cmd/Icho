<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khmer Walkie Talkie (Realtime Optimized)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js"
      }
    }
    </script>
    
    <style>
        body {
            background-color: #171717;
            color: white;
            font-family: 'Noto Sans Khmer', sans-serif;
            overscroll-behavior: none;
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #262626; 
        }
        ::-webkit-scrollbar-thumb {
            background: #525252; 
            border-radius: 3px;
        }
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        /* Animations */
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .toast-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
        .modal-enter {
            animation: fadeIn 0.2s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getDatabase, 
            ref, 
            set, 
            update, 
            push,
            onValue, 
            onChildAdded,
            remove,
            onDisconnect,
            query,
            limitToLast,
            serverTimestamp 
        } from 'firebase/database';
        import { Mic, Radio, Power, Users, Signal, Lock, X, List, AlertCircle, CheckCircle, Phone, ArrowLeft } from 'lucide-react';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAcfDALTjrGiD_Te5DyFp7x-F6NrPwqEr4",
            authDomain: "icho-7ddb4.firebaseapp.com",
            databaseURL: "https://icho-7ddb4-default-rtdb.firebaseio.com", 
            projectId: "icho-7ddb4",
            storageBucket: "icho-7ddb4.firebasestorage.app",
            messagingSenderId: "897027326100",
            appId: "1:897027326100:web:a5d726c168a3fc01d23481",
            measurementId: "G-0LPCL7ETRF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Constants ---
        // 11025Hz provides a good balance between clarity and speed
        const SAMPLE_RATE = 11025; 
        const CHUNK_SIZE_MS = 100; // Send audio every 100ms (reduces database overhead)
        const NOISE_THRESHOLD = 0.01; // Silence detection threshold

        // --- Toast Notification Component ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'error' ? 'bg-red-600' : (type === 'private' ? 'bg-purple-600' : 'bg-green-600');
            const icon = type === 'error' ? <AlertCircle size={20} /> : (type === 'private' ? <Phone size={20} /> : <CheckCircle size={20} />);

            return (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-50 flex items-center gap-3 px-6 py-3 rounded-full shadow-2xl text-white font-medium text-sm toast-enter ${bgClass}`}>
                    {icon}
                    <span>{message}</span>
                </div>
            );
        };

        // --- User List Modal Component ---
        const UserListModal = ({ users, onClose, currentUserId, onSelectUser }) => {
            return (
                <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 modal-enter">
                    <div className="bg-neutral-800 w-full max-w-sm rounded-3xl border border-neutral-700 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                        {/* Header */}
                        <div className="bg-neutral-900 p-4 flex justify-between items-center border-b border-neutral-700">
                            <h3 className="text-white font-bold text-lg flex items-center gap-2">
                                <Users size={20} className="text-green-500"/>
                                អ្នកកំពុង Online ({users.length})
                            </h3>
                            <button onClick={onClose} className="p-2 bg-neutral-800 rounded-full hover:bg-neutral-700 transition-colors">
                                <X size={18} className="text-gray-400" />
                            </button>
                        </div>
                        
                        {/* List */}
                        <div className="overflow-y-auto p-2 flex-1 space-y-2">
                            {users.length === 0 ? (
                                <div className="text-center text-neutral-500 py-8">គ្មានអ្នកផ្សេង Online ទេ</div>
                            ) : (
                                users.map(user => {
                                    const isMe = user.id === currentUserId;
                                    return (
                                        <div 
                                            key={user.id} 
                                            onClick={() => !isMe && onSelectUser(user)}
                                            className={`flex items-center gap-3 p-3 rounded-xl transition-all ${isMe ? 'bg-green-900/20 border border-green-800/30' : 'bg-neutral-700/30 hover:bg-neutral-600 cursor-pointer active:scale-95'}`}
                                        >
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold text-white shadow-md ${isMe ? 'bg-green-700' : 'bg-neutral-600'}`}>
                                                {user.name.charAt(0).toUpperCase()}
                                            </div>
                                            <div className="flex-1">
                                                <div className="font-bold text-white text-sm flex items-center gap-2">
                                                    {user.name}
                                                    {isMe && <span className="text-[10px] bg-green-600 px-1.5 rounded text-white">Me</span>}
                                                </div>
                                                <div className="text-[10px] text-green-400 flex items-center gap-1">
                                                    <div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                                                    Online
                                                </div>
                                            </div>
                                            {!isMe && (
                                                <div className="p-2 bg-purple-600/20 rounded-full text-purple-400">
                                                    <Phone size={16} />
                                                </div>
                                            )}
                                        </div>
                                    );
                                })
                            )}
                        </div>
                        <div className="p-3 text-center text-xs text-neutral-500 bg-neutral-900 border-t border-neutral-700">
                            ចុចលើឈ្មោះដើម្បីនិយាយឯកជន (Private)
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        function App() {
            // User & System State
            const [userId, setUserId] = useState(null);
            const [userName, setUserName] = useState('');
            const [isNameSet, setIsNameSet] = useState(false);
            const [tempName, setTempName] = useState('');
            const [notification, setNotification] = useState(null);
            
            // Walkie Talkie State
            const [powerOn, setPowerOn] = useState(false);
            const [currentChannel, setCurrentChannel] = useState('01');
            const [isTransmitting, setIsTransmitting] = useState(false);
            const [incomingTransmission, setIncomingTransmission] = useState(null); 
            
            // Private Mode State
            const [privateTarget, setPrivateTarget] = useState(null); 
            
            // Users Data
            const [onlineUsers, setOnlineUsers] = useState([]);
            const [showUserList, setShowUserList] = useState(false);

            // Audio Refs
            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const isTransmittingRef = useRef(false);
            
            const canvasRef = useRef(null);
            const processorRef = useRef(null);
            const streamRef = useRef(null);
            const requestRef = useRef(null);
            const nextStartTimeRef = useRef(0);
            
            // Buffering Refs for Batch Sending
            const audioBufferRef = useRef([]); // Stores float samples
            const samplesPerChunk = Math.floor(SAMPLE_RATE * (CHUNK_SIZE_MS / 1000));

            // --- Helpers ---
            const showToast = (msg, type = 'info') => {
                setNotification({ message: msg, type });
            };

            // --- 1. Initialization & Name Handling ---
            useEffect(() => {
                let storedId = localStorage.getItem('walkie_user_id');
                if (!storedId) {
                    storedId = 'user_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('walkie_user_id', storedId);
                }
                setUserId(storedId);

                const storedName = localStorage.getItem('walkie_user_name');
                if (storedName) {
                    setUserName(storedName);
                    setIsNameSet(true);
                }
            }, []);

            const handleNameSubmit = (e) => {
                e.preventDefault();
                if (tempName.trim().length > 0) {
                    const finalName = tempName.trim();
                    localStorage.setItem('walkie_user_name', finalName);
                    setUserName(finalName);
                    setIsNameSet(true);
                }
            };

            // --- 2. Presence System (Online/Offline) ---
            useEffect(() => {
                if (!userId || !userName) return;

                const userPresenceRef = ref(db, `channels/channel_${currentChannel}/users/${userId}`);

                if (powerOn) {
                    set(userPresenceRef, {
                        name: userName,
                        status: 'online',
                        lastSeen: serverTimestamp()
                    });
                    onDisconnect(userPresenceRef).remove();
                } else {
                    remove(userPresenceRef);
                    onDisconnect(userPresenceRef).cancel();
                }

                return () => {
                    if (powerOn) remove(userPresenceRef);
                };
            }, [powerOn, userId, userName, currentChannel]);

            // --- 3. Active Users Listener ---
            useEffect(() => {
                const usersRef = ref(db, `channels/channel_${currentChannel}/users`);
                const unsubscribe = onValue(usersRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const usersData = snapshot.val();
                        const usersList = Object.keys(usersData).map(key => ({
                            id: key,
                            ...usersData[key]
                        }));
                        setOnlineUsers(usersList);
                    } else {
                        setOnlineUsers([]);
                    }
                });
                return () => unsubscribe();
            }, [currentChannel]);

            // --- 4. Incoming Status Listener (Public) ---
            useEffect(() => {
                if (!userId || !powerOn) return;

                const statusRef = ref(db, `channels/channel_${currentChannel}/status`);
                const unsubscribe = onValue(statusRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.isActive && data.userId !== userId) {
                        setIncomingTransmission({
                            userId: data.userId,
                            userName: data.userName,
                            type: 'public'
                        });
                    } else {
                        setIncomingTransmission(prev => prev && prev.type === 'private' ? prev : null);
                    }
                });
                return () => unsubscribe();
            }, [userId, powerOn, currentChannel]);

            // --- 5. Audio Data Listener (Public) ---
            useEffect(() => {
                if (!userId || !powerOn) return;

                const audioRef = ref(db, `channels/channel_${currentChannel}/audio_stream`);
                const recentQuery = query(audioRef, limitToLast(1)); 
                
                const unsubscribe = onChildAdded(recentQuery, (snapshot) => {
                    const data = snapshot.val();
                    if (isTransmittingRef.current) return;

                    if (data && data.userId !== userId && data.pcmData) {
                         playPCMChunk(data.pcmData);
                    }
                });
                return () => unsubscribe();
            }, [userId, powerOn, currentChannel]);

            // --- 6. Audio Data Listener (PRIVATE) ---
            useEffect(() => {
                if (!userId || !powerOn) return;

                const privateAudioRef = ref(db, `private_stream/${userId}`);
                const recentQuery = query(privateAudioRef, limitToLast(1));

                const unsubscribe = onChildAdded(recentQuery, (snapshot) => {
                    const data = snapshot.val();
                    if (isTransmittingRef.current) return;

                    if (data && data.pcmData) {
                        setIncomingTransmission({
                            userId: data.senderId,
                            userName: data.senderName,
                            type: 'private'
                        });
                        
                        playPCMChunk(data.pcmData);

                        setTimeout(() => {
                             setIncomingTransmission(prev => prev && prev.type === 'private' && prev.userId === data.senderId ? null : prev);
                        }, 500);
                    }
                });
                return () => unsubscribe();
            }, [userId, powerOn]);


            // --- Optimized Audio Logic (8-bit PCM + Catch Up) ---
            const playPCMChunk = async (base64Data) => {
                const ctx = audioContextRef.current;
                if (!ctx) return;

                if (ctx.state === 'suspended') {
                    try { await ctx.resume(); } catch(e) {}
                }

                try {
                    const binaryString = window.atob(base64Data);
                    const len = binaryString.length;
                    const bytes = new Int8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }

                    const float32Data = new Float32Array(bytes.length);
                    for (let i = 0; i < bytes.length; i++) {
                        float32Data[i] = bytes[i] / 128.0; 
                    }

                    const buffer = ctx.createBuffer(1, float32Data.length, SAMPLE_RATE);
                    buffer.copyToChannel(float32Data, 0);

                    const source = ctx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(ctx.destination);

                    const currentTime = ctx.currentTime;
                    // AGGRESSIVE LATENCY FIX:
                    // If we are behind, jump to now. 
                    // If we are too far ahead (latency buildup), skip forward.
                    if (nextStartTimeRef.current < currentTime) {
                        nextStartTimeRef.current = currentTime;
                    } 
                    else if (nextStartTimeRef.current > currentTime + 0.3) {
                        // If buffer > 300ms, jump to near-realtime
                        nextStartTimeRef.current = currentTime + 0.05; 
                    }

                    source.start(nextStartTimeRef.current);
                    nextStartTimeRef.current += buffer.duration;
                } catch (err) {
                    console.error("Error playing PCM:", err);
                }
            };

            const animate = () => {
                if (!canvasRef.current || !analyserRef.current) return;
                
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const analyser = analyserRef.current;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                analyser.getByteFrequencyData(dataArray);

                ctx.fillStyle = '#1f2937'; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] / 2;
                    ctx.fillStyle = `rgb(50, ${barHeight + 100}, 50)`;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }

                requestRef.current = requestAnimationFrame(animate);
            };

            useEffect(() => {
                if (isTransmitting && powerOn) {
                    requestRef.current = requestAnimationFrame(animate);
                } else {
                    if (requestRef.current) cancelAnimationFrame(requestRef.current);
                    if (canvasRef.current) {
                        const ctx = canvasRef.current.getContext('2d');
                        ctx.fillStyle = '#1f2937';
                        ctx.fillRect(0, 0, canvasRef.current.width, canvasRef.current.height);
                        ctx.strokeStyle = '#374151';
                        ctx.beginPath();
                        ctx.moveTo(0, canvasRef.current.height / 2);
                        ctx.lineTo(canvasRef.current.width, canvasRef.current.height / 2);
                        ctx.stroke();
                    }
                }
                return () => {
                     if (requestRef.current) cancelAnimationFrame(requestRef.current);
                };
            }, [isTransmitting, powerOn]);

            const startTransmission = async (e) => {
                if(e) e.preventDefault();
                
                if (!privateTarget && onlineUsers.length <= 1) {
                    showToast("គ្មានអ្នកផ្សេង Online ទេ។ សូមរង់ចាំ...", "error");
                    return;
                }
                
                if (!powerOn || !userId || incomingTransmission) return;

                try {
                    const ctx = audioContextRef.current;
                    if (ctx && ctx.state === 'suspended') {
                        await ctx.resume();
                    }

                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            googHighpassFilter: true
                        } 
                    });
                    streamRef.current = stream;
                    
                    const source = ctx.createMediaStreamSource(stream);
                    if (analyserRef.current) {
                        source.connect(analyserRef.current);
                    }

                    // 4096 is safe. We handle batching manually.
                    const processor = ctx.createScriptProcessor(4096, 1, 1);
                    processorRef.current = processor;

                    const dummyDest = ctx.createMediaStreamDestination();
                    source.connect(processor);
                    processor.connect(dummyDest); 

                    // Clear accumulate buffer
                    audioBufferRef.current = [];

                    processor.onaudioprocess = (e) => {
                        if (!streamRef.current) return;
                        const inputData = e.inputBuffer.getChannelData(0);
                        const inputRate = ctx.sampleRate;
                        
                        // Downsample
                        const ratio = inputRate / SAMPLE_RATE;
                        
                        for (let i = 0; i < inputData.length; i += ratio) {
                            const idx = Math.floor(i);
                            if (idx >= inputData.length) break;
                            let s = Math.max(-1, Math.min(1, inputData[idx]));
                            
                            // Simple VAD (Voice Activity Detection) - Noise Gate
                            // If very quiet, treat as silence (0) to compress better,
                            // but here we just pass it. Real optimization: don't push silence.
                            
                            audioBufferRef.current.push(s);
                        }

                        // Send Batch if ready
                        if (audioBufferRef.current.length >= samplesPerChunk) {
                            sendAudioBatch();
                        }
                    };

                    setIsTransmitting(true);
                    isTransmittingRef.current = true;
                    
                    if (!privateTarget) {
                        const statusRef = ref(db, `channels/channel_${currentChannel}/status`);
                        onDisconnect(statusRef).update({ isActive: false });
                        await set(statusRef, {
                            isActive: true,
                            userId: userId,
                            userName: userName
                        });
                        const audioRef = ref(db, `channels/channel_${currentChannel}/audio_stream`);
                        remove(audioRef);
                    }

                    playBeep(600, 0.1);

                } catch (err) {
                    console.error("Error accessing mic:", err);
                    showToast("សូមអនុញ្ញាតឱ្យប្រើប្រាស់មីក្រូហ្វូន", "error");
                    setIsTransmitting(false);
                    isTransmittingRef.current = false;
                }
            };

            const sendAudioBatch = () => {
                if (audioBufferRef.current.length === 0) return;

                const floatData = audioBufferRef.current;
                const int8Buffer = new Int8Array(floatData.length);
                
                // Check if buffer has significant sound (VAD)
                let hasSound = false;
                for(let i=0; i<floatData.length; i++) {
                    if(Math.abs(floatData[i]) > NOISE_THRESHOLD) {
                        hasSound = true;
                    }
                    // Boost & Convert
                    let s = floatData[i] * 1.5;
                    if (s > 1) s = 1;
                    if (s < -1) s = -1;
                    int8Buffer[i] = s < 0 ? s * 128 : s * 127;
                }

                // Reset buffer
                audioBufferRef.current = [];

                if (!hasSound) return; // Skip silence

                // Convert to Binary String
                const uint8View = new Uint8Array(int8Buffer.buffer);
                let binaryStr = "";
                // Processing in small chunks to avoid call stack size exceeded
                const chunkSize = 8192;
                for (let i = 0; i < uint8View.length; i += chunkSize) {
                    binaryStr += String.fromCharCode.apply(null, uint8View.subarray(i, i + chunkSize));
                }
                
                const base64data = window.btoa(binaryStr);

                if (privateTarget) {
                    const privateRef = ref(db, `private_stream/${privateTarget.id}`);
                    push(privateRef, {
                        senderId: userId,
                        senderName: userName,
                        pcmData: base64data,
                        timestamp: serverTimestamp()
                    });
                } else {
                    const audioRef = ref(db, `channels/channel_${currentChannel}/audio_stream`);
                    push(audioRef, {
                        userId: userId,
                        pcmData: base64data,
                    });
                }
            };

            const stopTransmission = async (e) => {
                if(e) e.preventDefault();
                if (!isTransmitting) return;

                // Send remaining data
                sendAudioBatch();

                if (processorRef.current) {
                    processorRef.current.disconnect();
                    processorRef.current.onaudioprocess = null;
                    processorRef.current = null;
                }

                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                    streamRef.current = null;
                }

                setIsTransmitting(false);
                isTransmittingRef.current = false;
                playBeep(400, 0.1);

                if (!privateTarget) {
                    const statusRef = ref(db, `channels/channel_${currentChannel}/status`);
                    onDisconnect(statusRef).cancel();
                    await update(statusRef, { isActive: false });
                }
            };

            const playBeep = (freq, duration) => {
                const ctx = audioContextRef.current;
                if (!ctx) return;
                try {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'square';
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    osc.start();
                    osc.stop(ctx.currentTime + duration);
                } catch(e) {}
            };

            const handleChannelChange = (delta) => {
                if (!powerOn) return;
                if (privateTarget) {
                    showToast("សូមចាកចេញពី Private Mode ជាមុនសិន", "error");
                    return;
                }
                let newCh = parseInt(currentChannel) + delta;
                if (newCh < 1) newCh = 1;
                if (newCh > 99) newCh = 99;
                setCurrentChannel(newCh.toString().padStart(2, '0'));
                playBeep(800, 0.05);
            };

            const togglePower = async (e) => {
                e.stopPropagation();
                
                if (!powerOn) {
                    if (!audioContextRef.current) {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        const ctx = new AudioContext();
                        audioContextRef.current = ctx;
                        const anal = ctx.createAnalyser();
                        anal.fftSize = 256;
                        analyserRef.current = anal;
                        nextStartTimeRef.current = ctx.currentTime;
                    } else if (audioContextRef.current.state === 'suspended') {
                        await audioContextRef.current.resume();
                    }
                    
                    setPowerOn(true);
                    setTimeout(() => playBeep(1000, 0.2), 500);
                    showToast("បានបើកម៉ាស៊ីន (Power ON)", "success");
                } else {
                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                        streamRef.current = null;
                    }
                    if (processorRef.current) {
                        processorRef.current.disconnect();
                        processorRef.current = null;
                    }
                    setPowerOn(false);
                    isTransmittingRef.current = false;
                    setIsTransmitting(false);
                    setPrivateTarget(null);
                    showToast("បានបិទម៉ាស៊ីន (Power OFF)", "info");
                }
            };

            const handleUserSelect = (targetUser) => {
                setPrivateTarget(targetUser);
                setShowUserList(false);
                showToast(`បានចូល Private Mode ជាមួយ ${targetUser.name}`, "private");
            };

            const exitPrivateMode = () => {
                setPrivateTarget(null);
                showToast("បានត្រឡប់មកប៉ុស្តិ៍សាធារណៈវិញ", "info");
            };

            // --- UI: Name Input Modal ---
            if (!isNameSet) {
                return (
                    <div className="min-h-screen bg-neutral-900 flex items-center justify-center p-4 font-sans text-white">
                        <div className="bg-neutral-800 p-8 rounded-3xl border-2 border-neutral-700 w-full max-w-md modal-animate shadow-2xl">
                            <div className="flex justify-center mb-6">
                                <div className="p-4 bg-orange-600 rounded-full shadow-[0_0_20px_rgba(234,88,12,0.3)]">
                                    <Radio size={48} className="text-white" />
                                </div>
                            </div>
                            <h2 className="text-2xl font-bold text-center mb-2">បញ្ចូលឈ្មោះរបស់អ្នក</h2>
                            <p className="text-center text-neutral-400 mb-6 text-sm">សូមដាក់ឈ្មោះដើម្បីឱ្យអ្នកផ្សេងស្គាល់ (Realtime Radio)</p>
                            
                            <form onSubmit={handleNameSubmit} className="flex flex-col gap-4">
                                <input 
                                    type="text" 
                                    value={tempName}
                                    onChange={(e) => setTempName(e.target.value)}
                                    placeholder="ឈ្មោះរបស់អ្នក..."
                                    className="p-4 rounded-xl bg-neutral-900 border border-neutral-700 text-white placeholder-neutral-500 focus:outline-none focus:border-orange-500 text-center text-lg"
                                    autoFocus
                                    maxLength={15}
                                />
                                <button 
                                    type="submit" 
                                    disabled={!tempName.trim()}
                                    className="p-4 rounded-xl bg-orange-600 font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-orange-500 transition-colors shadow-lg"
                                >
                                    ចាប់ផ្តើម
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // --- Render Main App ---
            const isAlone = onlineUsers.length <= 1;
            const isPrivate = !!privateTarget;

            return (
                <div className="min-h-screen bg-neutral-900 flex items-center justify-center p-4 font-sans no-select overflow-hidden touch-none relative">
                    
                    {notification && <Toast message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}

                    {showUserList && (
                        <UserListModal 
                            users={onlineUsers} 
                            currentUserId={userId} 
                            onClose={() => setShowUserList(false)}
                            onSelectUser={handleUserSelect}
                        />
                    )}

                    <div className={`relative w-full max-w-sm bg-neutral-800 rounded-[3rem] shadow-2xl border-4 ${isPrivate ? 'border-purple-600' : 'border-neutral-700'} flex flex-col overflow-hidden transition-colors duration-500`}>
                        
                        <div className="absolute -top-16 right-8 w-6 h-24 bg-neutral-700 rounded-t-lg border-2 border-neutral-600 z-0"></div>
                        <div className={`absolute -top-4 left-8 w-3 h-6 ${isPrivate ? 'bg-purple-600' : 'bg-red-600'} rounded-sm z-0 animate-pulse`}></div>

                        <div className="mt-8 mx-auto w-3/4 grid grid-cols-6 gap-1 z-10 opacity-50">
                        {[...Array(24)].map((_, i) => (
                            <div key={i} className="w-1.5 h-1.5 bg-black rounded-full"></div>
                        ))}
                        </div>

                        <div className={`mx-6 mt-6 p-4 rounded-md shadow-inner border-4 border-neutral-600 relative overflow-hidden transition-colors duration-500 ${isPrivate ? 'bg-purple-200' : 'bg-[#9ea792]'}`}>
                            <div className="absolute inset-0 bg-green-900 opacity-10 pointer-events-none grid grid-cols-12 gap-px"></div>
                            
                            {/* Back Button for Private Mode - Larger and clearer */}
                            {isPrivate && powerOn && (
                                <button 
                                    onClick={exitPrivateMode}
                                    className="absolute top-2 left-2 p-2 bg-purple-700/20 text-purple-800 hover:bg-purple-700/30 rounded-full z-20 transition-all active:scale-95 border border-purple-800/20"
                                    aria-label="Back to Public Channel"
                                >
                                    <ArrowLeft size={24} strokeWidth={2.5} />
                                </button>
                            )}

                            {powerOn ? (
                                <div className="relative z-10 flex flex-col h-32 justify-between">
                                    <div className="flex justify-between items-center text-xs font-mono font-bold text-neutral-800">
                                        {/* User Count / Back Button Area */}
                                        <div className={`flex items-center gap-1 ${isPrivate ? 'invisible' : 'cursor-pointer hover:text-neutral-600'}`} onClick={() => !isPrivate && setShowUserList(true)}>
                                            {!isPrivate && <Users size={14} />}
                                            {!isPrivate && <span>ON: {onlineUsers.length}</span>}
                                        </div>
                                        <div className="flex items-center gap-1">
                                            {isPrivate ? <Lock size={14} /> : <Signal size={14} />}
                                            <span>CH {currentChannel}</span>
                                        </div>
                                    </div>

                                    <div className="text-center">
                                        {isTransmitting ? (
                                            <div className={`${isPrivate ? 'text-purple-700' : 'text-red-700'} font-bold text-lg animate-pulse flex flex-col items-center`}>
                                                <span>TRANSMITTING</span>
                                                <span className="text-xs mt-1">{isPrivate ? `TO: ${privateTarget.name}` : userName}</span>
                                            </div>
                                        ) : incomingTransmission ? (
                                            <div className={`${incomingTransmission.type === 'private' ? 'text-purple-800' : 'text-green-800'} font-bold text-lg flex flex-col items-center`}>
                                                <span>{incomingTransmission.type === 'private' ? 'PRIVATE CALL' : 'RECEIVING'}</span>
                                                <span className="text-sm truncate max-w-full">{incomingTransmission.userName}</span>
                                            </div>
                                        ) : (
                                            <div className="flex flex-col items-center">
                                                {isPrivate ? (
                                                    <>
                                                        <div className="text-purple-800 text-lg font-bold">PRIVATE</div>
                                                        <div className="text-purple-600 text-sm font-bold flex items-center gap-1 mt-1">
                                                            <Lock size={12}/> {privateTarget.name}
                                                        </div>
                                                    </>
                                                ) : (
                                                    <>
                                                        <div className="text-neutral-600 text-lg font-mono">STANDBY</div>
                                                        <div className="text-neutral-500 text-xs mt-1 font-mono">{userName}</div>
                                                    </>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    <div className={`text-4xl font-black font-mono text-center tracking-widest opacity-80 ${isPrivate ? 'text-purple-900' : 'text-neutral-800'}`}>
                                        {currentChannel}
                                    </div>
                                </div>
                            ) : (
                                <div className="h-32 flex items-center justify-center flex-col text-neutral-400 font-mono text-sm opacity-50">
                                    <span>POWER OFF</span>
                                    <span className="text-xs mt-2 text-neutral-500">({userName})</span>
                                </div>
                            )}
                        </div>

                        {/* Controls */}
                        <div className="p-6 flex flex-col gap-6 z-10 bg-neutral-800">
                            
                            <div className="h-16 bg-gray-900 rounded-lg border border-gray-700 overflow-hidden relative shadow-inner">
                                <canvas 
                                    ref={canvasRef} 
                                    width="300" 
                                    height="64" 
                                    className="w-full h-full opacity-80"
                                />
                                <div className="absolute top-1 left-2 text-[10px] text-green-500 font-mono">AUDIO LEVEL</div>
                            </div>

                            <div className="flex justify-between items-center px-2">
                                <button 
                                    onClick={togglePower}
                                    className={`p-4 rounded-full border-b-4 active:border-b-0 active:translate-y-1 transition-all ${powerOn ? 'bg-green-600 border-green-800 text-white shadow-[0_0_15px_rgba(34,197,94,0.5)]' : 'bg-red-600 border-red-800 text-white'}`}
                                >
                                    <Power size={24} />
                                </button>

                                <div className="flex flex-col items-center gap-2 bg-neutral-900 p-2 rounded-xl border border-neutral-700">
                                    <span className="text-[10px] text-gray-400 uppercase tracking-wider">Channel</span>
                                    <div className="flex items-center gap-3">
                                        <button 
                                            disabled={!powerOn || isPrivate}
                                            onClick={() => handleChannelChange(-1)}
                                            className="w-10 h-10 bg-neutral-700 rounded-lg flex items-center justify-center active:bg-neutral-600 disabled:opacity-50 text-white"
                                        >
                                            -
                                        </button>
                                        <span className={`font-mono text-xl w-6 text-center ${isPrivate ? 'text-purple-500' : 'text-green-500'}`}>{currentChannel}</span>
                                        <button 
                                            disabled={!powerOn || isPrivate}
                                            onClick={() => handleChannelChange(1)}
                                            className="w-10 h-10 bg-neutral-700 rounded-lg flex items-center justify-center active:bg-neutral-600 disabled:opacity-50 text-white"
                                        >
                                            +
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div className="relative group">
                                <button
                                    disabled={!powerOn || (isAlone && !isPrivate)}
                                    onMouseDown={startTransmission}
                                    onMouseUp={stopTransmission}
                                    onMouseLeave={stopTransmission}
                                    onTouchStart={startTransmission}
                                    onTouchEnd={stopTransmission}
                                    className={`
                                        w-full py-8 rounded-2xl font-bold text-xl tracking-widest text-white shadow-lg transition-all
                                        border-b-8 active:border-b-0 active:translate-y-2 select-none
                                        flex items-center justify-center gap-3
                                        ${powerOn 
                                            ? isAlone && !isPrivate
                                                ? 'bg-neutral-600 border-neutral-700 cursor-not-allowed opacity-70' 
                                                : isPrivate
                                                    ? 'bg-purple-600 border-purple-800 hover:bg-purple-500 cursor-pointer'
                                                    : 'bg-orange-600 border-orange-800 hover:bg-orange-500 cursor-pointer' 
                                            : 'bg-neutral-600 border-neutral-700 cursor-not-allowed opacity-50'}
                                    `}
                                >
                                    {isAlone && powerOn && !isPrivate ? (
                                        <>
                                            <Lock size={20} className="text-neutral-400" />
                                            <span className="text-sm">WAITING FOR USERS...</span>
                                        </>
                                    ) : (
                                        <>
                                            <Mic className={`${isTransmitting ? 'animate-pulse' : ''}`} />
                                            <span>{isTransmitting ? 'TRANSMITTING' : 'PUSH TO TALK'}</span>
                                        </>
                                    )}
                                </button>
                                
                                <div className="absolute inset-0 pointer-events-none opacity-10 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')]"></div>
                            </div>

                            <div className="mt-2 text-center h-4">
                                {isAlone && powerOn && !isPrivate ? (
                                    <p className="text-yellow-500 text-xs animate-pulse">កំពុងរង់ចាំអ្នកផ្សេង Online...</p>
                                ) : powerOn ? (
                                    <button 
                                        onClick={() => setShowUserList(true)}
                                        className="text-xs text-neutral-500 hover:text-green-400 flex items-center justify-center gap-1 transition-colors"
                                    >
                                        <List size={12} />
                                        <span>មើលអ្នក Online</span>
                                    </button>
                                ) : null}
                            </div>
                        </div>

                        <div className="absolute bottom-4 left-4 w-3 h-3 rounded-full bg-neutral-900 border border-neutral-600 flex items-center justify-center">
                            <div className="w-full h-0.5 bg-neutral-700 rotate-45"></div>
                        </div>
                        <div className="absolute bottom-4 right-4 w-3 h-3 rounded-full bg-neutral-900 border border-neutral-600 flex items-center justify-center">
                            <div className="w-full h-0.5 bg-neutral-700 rotate-45"></div>
                        </div>
                    </div>

                    <div className="fixed bottom-4 flex flex-col items-center gap-1 text-neutral-500 text-xs">
                        <p>ចុចប៊ូតុង <span className={`${isPrivate ? 'text-purple-500' : 'text-orange-500'} font-bold`}>PUSH TO TALK</span> ឲ្យជាប់ដើម្បីនិយាយ</p>
                        <div className="flex items-center gap-1">
                            <span>ត្រូវប្រាកដថាបានបើក</span>
                            <Power size={12} className="text-green-500"/>
                            <span>ជាមុនសិន</span>
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
